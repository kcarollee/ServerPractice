var socket,uColor,data2,clientNodes,font,pgFont,pg2Font,clients,cnodeArr,clientIndex,messageArr,disconnectedNodes,pg,shd,bbShd,gl,pg2,pg2bbm,pg2Mid,fontSize=15,firstFlag=!0,nameSet=!1,clientName="",errFlag=!1;function preload(){font=loadFont("assets/dos.ttf"),pg=createGraphics(windowWidth,windowHeight,WEBGL),pg2=createGraphics(windowWidth,windowHeight,WEBGL),pg2bb=createGraphics(windowWidth,windowHeight,WEBGL),pg2Mid=createGraphics(windowWidth,windowHeight,WEBGL),pgFont=pg.loadFont("assets/dos.ttf"),pg2Font=pg2.loadFont("assets/dos.ttf"),shd=loadShader("assets/Shader.vert","assets/Shader.frag"),bbShd=loadShader("assets/bbShader.vert","assets/bbShader.frag")}function setup(){createCanvas(windowWidth,windowHeight,WEBGL),pg.textFont(pgFont),pg.textSize(fontSize),pg.frameRate(30),pg2.textFont(pgFont),pg2.textSize(fontSize),pg2.frameRate(30),textFont(font),textSize(fontSize),frameRate(30),(socket=io()).on("clientNodes",e=>{if(cnodeArr=e.arr,disconnectedNodes=e.prevArr,firstFlag)clients=[],messageArr=e.messages,cnodeArr.forEach(e=>{let t=new ClientNode(e.x,e.y,e.z,e.id,e.index,e.color);clients.push(t)}),firstFlag=!1;else if(clients.length<cnodeArr.length){let e=cnodeArr[cnodeArr.length-1],t=new ClientNode(e.x,e.y,e.z,e.id,e.index,e.color);clients.push(t)}else if(clients.length>cnodeArr.length){var t;clients.splice(e.lastDeletedIndex,1),e.lastDeletedIndex<clientIndex&&clientIndex--,clients.forEach(n=>{n.index>e.lastDeletedIndex&&n.index--;try{for(let s=0;s<n.receivedMessageData.length;s++)t=s,e.lastDeletedIndex<n.receivedMessageData[s].index?n.receivedMessageData[s].index--:e.lastDeletedIndex==n.receivedMessagesData[s].index&&n.spliceArrays(s)}catch(e){console.log("ERR TRIGGERED: "+clientIndex+" "+t),errFlag=!0}})}}),socket.on("newClientNode",e=>{clientIndex=e.index}),socket.on("newName",e=>{clients[e.index].id=e.name}),socket.on("newMessage",e=>{for(let t=0;t<clients.length;t++)clients[t].index!=e.index&&(clients[t].displayReceivedMessage=!0,clients[t].receivedMessageData.push({msg:e.msg,index:e.index,color:e.color}),clients[t].receivedMessagesCopy.push(""),clients[t].distancesFromReceivedNode.push(dist(clients[t].xpos,clients[t].ypos,clients[t].zpos,e.x,e.y,e.z)),clients[t].receivedMessagesCopyIndices.push(e.msg.length-1),clients[t].charDeletionNums.push(0),clients[t].charPushedNums.push(0),clients[t].interruptFlags.push(!1))}),socket.on("messageArray",e=>{messageArr=e.arr}),socket.on("previousUsers",e=>{disconnectedNodes=e.arr}),(gl=this._renderer.GL).disable(gl.DEPTH_TEST),pggl=pg._renderer.GL}function draw(){pg.background(0),pg.ambientLight(60,60,60),pg.pointLight(255,255,255,0,0,200),pg.rotateX(PI),nameSet||(pg.push(),pg.translate(0,.3*-height,-100),pg.fill(255),pg.textSize(50),pg.textAlign(CENTER),pg.fill(0,255,0),pg.text("ENTER YOUR NAME: "+clientName,0,0),pg.textSize(fontSize),pg.textAlign(LEFT),pg.pop());try{pg.push(),clients.forEach(e=>{if(void 0!==e){var t=.005;if(pg.push(),pg.rotateX(.01*frameCount+mouseY*t),pg.rotateY(.01*frameCount+mouseX*t),pg.rotateZ(.01*frameCount),pg.translate(e.xpos,e.ypos,e.zpos),pg.rotateZ(.01*-frameCount),pg.rotateY(.01*-frameCount-mouseX*t),pg.rotateX(.01*-frameCount-mouseY*t),e.index==clientIndex?pg.fill(0,255,0):pg.fill(255),pg.textAlign(CENTER),pg.text(e.id,0,1.25*-fontSize),pg.textAlign(LEFT),pg.pop(),pg.push(),pg.rotateX(.01*frameCount+mouseY*t),pg.rotateY(.01*frameCount+mouseX*t),pg.rotateZ(.01*frameCount),e.display(pg),e.displayReceivedMessage)try{for(let t=0;t<e.receivedMessageData.length;t++){pg.push(),pg.translate(clients[e.receivedMessageData[t].index].xpos,clients[e.receivedMessageData[t].index].ypos,clients[e.receivedMessageData[t].index].zpos);let n=createVector(clients[e.receivedMessageData[t].index].xpos,clients[e.receivedMessageData[t].index].ypos,clients[e.receivedMessageData[t].index].zpos),s=createVector(e.xpos,e.ypos,e.zpos),i=p5.Vector.sub(s,n).normalize(),a=createVector(1,0,0),r=p5.Vector.add(i,a).normalize();pg.rotate(PI,r),pg.push(),pg.rotate(.1*frameCount,[1,0,0]),e.index==clientIndex?pg.fill(255,0,0):pg.fill(clients[e.receivedMessageData[t].index].color),pg.text(e.receivedMessagesCopy[t],0,0),pg.pop(),pg.pop()}e.modifyCopiedMessage()}catch(e){}pg.pop()}}),pg.pop()}catch(e){}pg2.textSize(fontSize),pg2.background(0),pg2.push();try{pg2.push(),pg2.rotateX(.01*frameCount),pg2.rotateY(.01*frameCount),disconnectedNodes.forEach(e=>{pg2.push(),pg2.translate(e.x,e.y,e.z),pg2.noFill(),pg2.stroke(0,0,255),pg2.rotateX(.01*frameCount+e.index),pg2.rotateY(.01*frameCount+e.index),pg2.box(15),pg2.pop(),pg2.push(),pg2.fill(0,255,255),pg2.translate(e.x,e.y,e.z),pg2.rotateY(.01*-frameCount),pg2.rotateX(.01*-frameCount),pg2.textAlign(CENTER),pg2.text("OFF",0,1.2*-fontSize),pg2.textAlign(LEFT),pg2.pop()});var e=int(random(0,disconnectedNodes.length)),t=int(random(0,disconnectedNodes.length)),n=disconnectedNodes[e],s=disconnectedNodes[t];pg2.push(),pg2.strokeWeight(3),pg2.stroke(0,0,255),pg2.line(n.x,n.y,n.z,s.x,s.y,s.z),pg2.pop(),pg2.pop()}catch(e){}pg2Mid.shader(bbShd),bbShd.setUniform("tex",pg2),bbShd.setUniform("bbTex",pg2bb),bbShd.setUniform("resolution",[pg.width,pg.height]),pg2Mid.rect(10,10,10,10),push(),shader(shd),shd.setUniform("tex",pg),shd.setUniform("tex2",pg2),shd.setUniform("tex2bb",pg2Mid),shd.setUniform("resolution",[pg.width,pg.height]),shd.setUniform("time",frameCount),rectMode(CENTER),rect(0,0,300+300*sin(frameCount),600),pop(),pg._renderer._update(),pg2._renderer._update(),pg2bb.rotateX(PI),pg2bb.image(pg2Mid,.5*-pg.width,.5*-pg.height),pg2bb._renderer._update(),push();fill(255);var i=-.475*width,a=.3*height;try{errFlag&&(fill(255,0,0),text("AN ERROR MAY HAVE OCCURRED.",i,a-60)),text("type >rx to send a random string of length x. ex) >r100",i,a-20),1==clients.length?text("1 USER ONLINE",i,a-40):text(clients.length+" USERS ONLINE",i,a-40);for(let e=0;e<messageArr.length;e++)fill(255),text(messageArr[e].id+":  "+messageArr[e].msg,i,a+20*e);fill(255),text("YOU ("+clients[clientIndex].id+"):  "+clients[clientIndex].message,i,a+120)}catch(e){}}function isNumeric(e,t){if(e=String(e).replace(/^\s+|\s+$/g,""),void 0===t||"1"==t)var n=/^[+\-]?(([1-9][0-9]{0,2}(,[0-9]{3})*)|[0-9]+){1}(\.[0-9]+)?$/g;else if("2"==t)n=/^(([1-9][0-9]{0,2}(,[0-9]{3})*)|[0-9]+){1}(\.[0-9]+)?$/g;else if("3"==t)n=/^[0-9]+(\.[0-9]+)?$/g;else n=/^[0-9]$/g;return!!n.test(e)&&(e=e.replace(/,/g,""),!isNaN(e))}function isRandomSender(e){return">"==e[0]&&"r"==e[1]&&!(!isNumeric(e.substring(2,e.length))||includesSpace(e.substring(2,e.length)))}function randomString(e){var t="";for(let n=0;n<e;n++)t+=String.fromCharCode(int(random(33,127)));return t}function keyPressed(){if(nameSet)switch(keyCode){case ENTER:if(isRandomSender(clients[clientIndex].message)){var e=parseInt(clients[clientIndex].message.substring(2,clients[clientIndex].message.length));clients[clientIndex].message=randomString(e)}var t={x:clients[clientIndex].xpos,y:clients[clientIndex].ypos,z:clients[clientIndex].zpos,msg:clients[clientIndex].message,index:clients[clientIndex].index,id:clients[clientIndex].id,color:clients[clientIndex].color,sendTo:[0,1]};clients[clientIndex].sendMessage=!0,socket.emit("newMessage",t),clients[clientIndex].message="";break;case BACKSPACE:clients[clientIndex].message=clients[clientIndex].message.slice(0,clients[clientIndex].message.length-1);break;case SHIFT:case CONTROL:break;default:clients[clientIndex].message+=key}else switch(keyCode){case ENTER:if(!includesSpace(clientName)){nameSet=!0,clients[clientIndex].id=clientName;var n={name:clientName,index:clientIndex};socket.emit("newName",n)}break;case BACKSPACE:clientName=clientName.slice(0,clientName.length-1);break;case SHIFT:break;default:clientName.length<10&&(clientName+=key)}}function windowResized(){resizeCanvas(windowWidth,windowHeight),pg.resizeCanvas(windowWidth,windowHeight),pg2.resizeCanvas(windowWidth,windowHeight),pg2bb.resizeCanvas(windowWidth,windowHeight),pg2Mid.resizeCanvas(windowWidth,windowHeight)}function includesSpace(e){for(let t=0;t<e.length;t++)if(" "==e[t])return!0;return!1}